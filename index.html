<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Ora - Bacheca Lavoro</title>
    
    <link id="favicon" rel="icon" href="#">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        body{font-family:'Roboto',sans-serif;color:#333;margin:0;padding:2rem;display:flex;flex-direction:column;align-items:center}#background-video{position:fixed;left:0;bottom:0;min-width:100%;min-height:100%;width:auto;height:auto;z-index:-100;object-fit:cover}
        #presence-indicator{position:fixed;top:10px;left:10px;background-color:rgba(0,0,0,.4);color:#fff;padding:5px 10px;border-radius:5px;font-size:.8rem;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);z-index:1000;line-height:1.4}
        .controls-container{display:flex;gap:10px;margin-bottom:1rem;background-color:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:.5rem 1rem;border-radius:8px}.controls-container button{padding:8px 15px;border-radius:5px;border:1px solid #fff;background-color:#2c3e50;color:#fff;font-weight:700;cursor:pointer;transition:background-color .2s}.controls-container button:hover{background-color:#34495e}
        .header-container{display:flex;justify-content:center;align-items:center;width:100%;max-width:1500px;margin-bottom:1.5rem;gap:2rem}
        .day-selector{display:flex;justify-content:center;flex-wrap:wrap;background-color:rgba(255,255,255,.2);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:1rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05);flex-grow:1}.day-selector button{backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.8);border-radius:5px;padding:10px 15px;margin:5px;font-size:.9rem;cursor:pointer;transition:background-color .2s,color .2s,border-color .2s;color:#fff;font-weight:700}.day-color-0{background-color:rgba(255,179,186,.7)}.day-color-1{background-color:rgba(255,223,186,.7)}.day-color-2{background-color:rgba(255,255,186,.7)}.day-color-3{background-color:rgba(186,255,201,.7)}.day-color-4{background-color:rgba(186,225,255,.7)}.day-color-5{background-color:rgba(215,186,255,.7)}.day-color-6{background-color:rgba(255,186,236,.7)}.day-selector button.active{background-color:#2c3e50;color:#fff;border-color:#fff}
        .daily-author-container{display:flex;align-items:center;gap:10px;background-color:rgba(0,0,0,.2);padding:10px 15px;border-radius:8px;flex-shrink:0}.daily-author-container label{font-weight:700;color:#fff;text-shadow:1px 1px 2px #000}.author-input{padding:8px;border-radius:5px;border:1px solid #777;width:150px}
        .kanban-board{display:flex;gap:2rem;justify-content:center;width:100%;max-width:1400px}
        .column{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);padding:1.5rem;border-radius:8px;width:300px;min-height:500px;box-shadow:0 4px 30px rgba(0,0,0,.1);display:flex;flex-direction:column}.column.done-column{width:250px}.column-header{font-size:1.5rem;font-weight:700;margin-bottom:1rem;color:#eee;text-shadow:1px 1px 3px rgba(0,0,0,.4);text-align:center}.add-task{display:flex;margin-bottom:1rem}.add-task input{flex-grow:1;padding:10px;border:1px solid #ccc;border-radius:5px;font-size:.9rem}.add-task button{padding:10px 15px;border:none;background-color:#2c3e50;color:#fff;border-radius:5px;margin-left:5px;cursor:pointer;font-size:.9rem}.task-list{flex-grow:1;overflow-y:auto;position:relative;min-height:100px}.task-card{background:rgba(255,255,255,.2);padding:1rem;border-radius:5px;margin-bottom:1rem;cursor:grab;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;position:relative}.task-card:active{cursor:grabbing}.task-card.dragging{opacity:.5;box-shadow:0 4px 15px rgba(0,0,0,.2);transform:scale(1.05)}
        .task-card.done{background:rgba(46,204,113,.2);color:#333}.task-card.done h4{text-decoration:none;color:#c0392b}
        .task-card.done .task-buttons{display:none}.task-card.done .content-tags button{opacity:.5;pointer-events:none}.task-card-header{display:flex;justify-content:space-between;align-items:center}.task-card h4{margin:0 0 .5rem;font-size:1.1rem;color:#c0392b;flex-grow:1;cursor:text}.task-card h4[contenteditable=true]{background-color:rgba(255,255,255,.8);outline:2px solid #3498db;border-radius:3px;padding:2px 4px;margin:-2px -4px .5rem -4px;color:#333}.info-field-container{margin-top:10px}.info-field-container label{font-size:.9rem;font-weight:700;color:#444;display:block;margin-bottom:5px}.info-field{width:calc(100% - 10px);padding:5px;border:1px solid #ccc;border-radius:3px;font-size:.9rem;resize:vertical;font-family:inherit}.task-card .task-buttons{display:flex;justify-content:space-between;margin-top:1rem}.task-card .task-buttons button,.minimize-btn{background:0 0;border:none;cursor:pointer;font-size:1.2rem;color:#333;transition:color .2s}.minimize-btn{font-size:1rem;margin-left:10px;padding:0 5px}.task-card .task-buttons button:hover,.minimize-btn:hover{color:#000}.task-card.minimized .task-body{display:none}.task-card.minimized h4{margin-bottom:0}.content-tags{display:flex;flex-wrap:wrap;align-items:center}
        .content-tags button{padding:5px 10px;border-radius:20px;border:none;cursor:pointer;color:#fff;font-size:.8rem;margin-right:5px;margin-bottom:5px;opacity:.3;transition:opacity .2s,filter .2s;filter:grayscale(60%)}.content-tags button.active{opacity:1;filter:grayscale(0%)}
        .content-tags .foto{background-color:#ff6347}.content-tags .video{background-color:#4682b4}.content-tags .grafico{background-color:#3cb371}.content-tags .titolo{background-color:#ffa500}.content-tags .cartina{background-color:#a0522d}.project-tag{padding:5px 10px;border-radius:20px;border:1px solid #ccc;cursor:pointer;font-size:.8rem;margin-right:5px;margin-bottom:5px;background-color:#2c3e50;color:#fff}
        .location-container h5{margin:.8rem 0 .5rem;font-size:1rem;color:#444}.location-buttons{display:flex;gap:10px;margin-bottom:.5rem}.location-btn{padding:5px 10px;font-size:.8rem;border-radius:5px;border:1px solid #aaa;background-color:#eee;cursor:pointer}.location-btn.active{background-color:#3498db;color:#fff;border-color:#3498db}
        .request-status-container{margin-top:15px;border-top:1px solid rgba(0,0,0,.1);padding-top:15px;display:flex;flex-direction:column;gap:15px}
        .request-row{display:block}.request-activation-btn{margin-bottom:8px}
        .request-status-indicator{display:flex;align-items:center;gap:5px;flex-grow:1;flex-wrap:wrap}.request-status-indicator span{font-size:.9rem;font-weight:700;color:#444;flex-shrink:0}
        .request-activation-btn{padding:5px 10px;font-size:.9rem;border-radius:5px;border:1px solid #aaa;background-color:#eee;cursor:pointer;transition:all .2s}.request-activation-btn.active{background-color:#3498db;color:#fff;border-color:#3498db}
        .status-toggle-btn{padding:4px 8px;font-size:.8rem;border-radius:5px;border:1px solid;cursor:pointer;transition:background-color .2s,color .2s,border-color .2s;flex-shrink:0}.status-toggle-btn[data-status=no]{background-color:rgba(231,76,60,.1);color:#c0392b;border-color:#e74c3c}.status-toggle-btn[data-status=yes]{background-color:rgba(46,204,113,.2);color:#27ae60;border-color:#2ecc71}
        .hidden{display:none !important}
        .link-row{display:flex;align-items:center;gap:5px;margin-bottom:5px}.link-row input{flex-grow:1}.remove-link-btn{background:0 0;border:none;cursor:pointer;font-size:1.2rem;color:#888;padding:0 5px}.remove-link-btn:hover{color:#000}
        .add-link-btn{width:30px;height:30px;margin-top:5px;padding:0;font-size:1.2rem;font-weight:700;color:#3498db;background-color:rgba(255,255,255,.4);border:1px dashed #3498db;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        @media (max-width:1300px){.kanban-board{flex-direction:column;align-items:center}}
        @media (max-width:900px){.kanban-board{flex-direction:column;align-items:center}.column{width:100%;max-width:400px;margin-bottom:20px}.header-container{flex-direction:column;align-items:stretch}}
    </style>
</head>
<body>
    <video autoplay muted loop id="background-video">
        <source src="background.mp4" type="video/mp4">
        Il tuo browser non supporta il tag video.
    </video>
    
    <div id="presence-indicator">Connessione...</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD3Ry99dV34fUo6NfzZ5ykSjPcJN1gl8mk", authDomain: "prima-ora-task-registi.firebaseapp.com", projectId: "prima-ora-task-registi", storageBucket: "prima-ora-task-registi.firebasestorage.app", messagingSenderId: "1090920780195", appId: "1:1090920780195:web:89059a93c18fc97bc08a16", databaseURL: "https://prima-ora-task-registi-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();
    </script>

    <div class="controls-container">
        <button id="export-btn">Esporta dati</button>
        <button id="import-btn">Importa dati</button>
        <input type="file" id="import-file-input" accept=".json" style="display: none;">
    </div>

    <div class="header-container">
        <div class="daily-author-container">
            <label for="author-input">Autore:</label>
            <input type="text" id="author-input" class="author-input" placeholder="Nome autore...">
        </div>
        <div class="day-selector" id="day-selector"></div>
    </div>
    
    <div id="kanban-container"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const daysToDisplay = 8;
            generateDaySelectors(daysToDisplay);
            document.getElementById('export-btn').addEventListener('click', exportData);
            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('import-btn').addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importData);
            animateFavicon();
            setupPresence();
        });

        const dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
        const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        let activeDate = '';
        let unsubscribeListener = null;

        function setupPresence() {
            const presenceRef = rtdb.ref('/presence');
            const myRef = presenceRef.push();
            const getLocation = async () => {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    return { city: data.city, country: data.country_code };
                } catch (error) {
                    console.error("Errore nel recuperare la geolocalizzazione:", error);
                    return { city: 'Sconosciuto', country: 'N/A' };
                }
            };
            rtdb.ref('.info/connected').on('value', async (snap) => {
                if (snap.val() === true) {
                    const location = await getLocation();
                    myRef.set({ online: true, location: `${location.city}, ${location.country}` });
                    myRef.onDisconnect().remove();
                }
            });
            presenceRef.on('value', (snapshot) => {
                const presenceIndicator = document.getElementById('presence-indicator');
                const userCount = snapshot.numChildren();
                const locations = new Set();
                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    if (userData.location) locations.add(userData.location);
                });
                const locationsArray = [...locations];
                let locationsHtml;
                if (locationsArray.length > 1) {
                    locationsHtml = '<br>' + locationsArray.join('<br>');
                } else {
                    locationsHtml = ` (${locationsArray.join(', ') || 'N/A'})`;
                }
                presenceIndicator.innerHTML = `Utenti connessi: ${userCount}${locationsHtml}`;
            });
        }
        
        // ... (resto del codice è completo e invariato)
        function animateFavicon() {
            const favicon = document.getElementById('favicon');
            if (!favicon) return;
            const icons = ['🕕', '📡'];
            let counter = 0;
            setInterval(() => {
                const emoji = icons[counter % icons.length];
                const newHref = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>${emoji}</text></svg>`;
                favicon.setAttribute('href', newHref);
                counter++;
            }, 1500);
        }
        function sanitizeHTML(str) { if (!str) return ''; return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
        function exportData() {
            const dateToExp = activeDate;
            if(!dateToExp) { alert("Seleziona un giorno da esportare."); return; }
            db.collection('bacheche').doc(dateToExp).get().then(doc => {
                if (!doc.exists) { alert("Nessun dato da esportare per questo giorno."); return; }
                const dataToExport = doc.data();
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup-bacheca-${dateToExp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            });
        }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const dateFromFile = file.name.replace('backup-bacheca-', '').replace('.json', '');
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateFromFile)) { alert("Nome del file non valido."); return; }
            if (!confirm(`ATTENZIONE: Stai per sovrascrivere i dati del giorno ${dateFromFile}. Vuoi continuare?`)) { event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    db.collection('bacheche').doc(dateFromFile).set(importedData).then(() => { alert(`Dati per il giorno ${dateFromFile} importati con successo!`); });
                } catch (error) {
                    alert('Errore: Il file selezionato non è valido o è corrotto.');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }
        function generateDaySelectors(count) {
            const selectorContainer = document.getElementById('day-selector');
            const kanbanContainer = document.getElementById('kanban-container');
            const today = new Date();
            for (let i = -2; i < count - 2; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                const dateString = day.toISOString().split('T')[0];
                const buttonText = `${dayNames[day.getDay()]} ${day.getDate()} ${monthNames[day.getMonth()]}`;
                const button = document.createElement('button');
                button.textContent = buttonText; button.setAttribute('data-date', dateString); button.classList.add(`day-color-${day.getDay()}`); button.addEventListener('click', () => switchDay(dateString));
                selectorContainer.appendChild(button);
                const kanbanBoard = document.createElement('div');
                kanbanBoard.id = `board-${dateString}`; kanbanBoard.className = 'kanban-board'; kanbanBoard.style.display = 'none';
                kanbanBoard.innerHTML = `
                    <div class="column" id="comms-column-${dateString}"><h2 class="column-header">Comunicazioni importanti</h2><textarea class="info-field comms-field-1" rows="5" placeholder="Descrizione"></textarea><div class="info-field-container"><label>Requisiti:</label><textarea class="info-field comms-field-2" rows="10" placeholder="Materiale, tecnica, ..."></textarea></div></div>
                    <div class="column" id="todo-column-${dateString}"><h2 class="column-header">📝 Da fare</h2><div class="add-task"><input type="text" id="todo-input-${dateString}" placeholder="Aggiungi nuovo compito..."><button class="add-btn" data-date="${dateString}">Aggiungi</button></div><div class="task-list" id="todo-list-${dateString}"></div></div>
                    <div class="column" id="in-progress-column-${dateString}"><h2 class="column-header">⏳ In corso</h2><div class="task-list" id="in-progress-list-${dateString}"></div></div>
                    <div class="column done-column" id="done-column-${dateString}"><h2 class="column-header">✅ Pronti</h2><div class="task-list" id="done-list-${dateString}"></div></div>`;
                kanbanContainer.appendChild(kanbanBoard);
                kanbanBoard.querySelector('.add-btn').addEventListener('click', () => {
                    const input = document.getElementById(`todo-input-${dateString}`);
                    if (input.value.trim() !== '') { createTaskCard(input.value, {}, dateString); input.value = ''; saveTasks(dateString); }
                });
                kanbanBoard.querySelector('.comms-field-1').addEventListener('change', () => saveTasks(dateString));
                kanbanBoard.querySelector('.comms-field-2').addEventListener('change', () => saveTasks(dateString));
                kanbanBoard.querySelectorAll('.task-list').forEach(list => { list.addEventListener('dragover', dragOver); list.addEventListener('drop', drop); });
            }
            document.getElementById('author-input').addEventListener('change', () => saveTasks(activeDate));
            switchDay(new Date().toISOString().split('T')[0]);
        }
        function switchDay(date) {
            document.querySelectorAll('.day-selector button').forEach(btn => { btn.classList.toggle('active', btn.getAttribute('data-date') === date); });
            document.querySelectorAll('.kanban-board').forEach(board => { board.style.display = 'none'; });
            document.getElementById(`board-${date}`).style.display = 'flex';
            activeDate = date;
            if (unsubscribeListener) unsubscribeListener();
            unsubscribeListener = db.collection('bacheche').doc(activeDate).onSnapshot(snapshot => {
                ['todo', 'in-progress', 'done'].forEach(type => { const list = document.getElementById(`${type}-list-${activeDate}`); if (list) list.innerHTML = ''; });
                const data = snapshot.data();
                document.getElementById('author-input').value = data?.autore || '';
                const comms1 = document.querySelector(`#board-${activeDate} .comms-field-1`);
                const comms2 = document.querySelector(`#board-${activeDate} .comms-field-2`);
                if(comms1) comms1.value = data?.comunicazione1 || '';
                if(comms2) comms2.value = data?.comunicazione2 || '';
                if (data) {
                    data.todo?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `todo-list-${activeDate}` }));
                    data.inProgress?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `in-progress-list-${activeDate}` }));
                    data.done?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `done-list-${activeDate}` }));
                }
            });
        }
        function saveTasks(date) {
            const tasks = { autore: document.getElementById('author-input').value || '', comunicazione1: document.querySelector(`#board-${date} .comms-field-1`)?.value || '', comunicazione2: document.querySelector(`#board-${date} .comms-field-2`)?.value || '', todo: [], inProgress: [], done: [] };
            document.querySelectorAll(`#todo-list-${date} .task-card`).forEach(card => tasks.todo.push(serializeCard(card)));
            document.querySelectorAll(`#in-progress-list-${date} .task-card`).forEach(card => tasks.inProgress.push(serializeCard(card)));
            document.querySelectorAll(`#done-list-${date} .task-card`).forEach(card => tasks.done.push(serializeCard(card)));
            db.collection('bacheche').doc(date).set(tasks);
        }
        function createTaskCard(baseText, initialData = {}, date = activeDate) {
            const card = document.createElement('div');
            card.className = 'task-card'; card.setAttribute('draggable', 'true'); card.id = initialData.id || `task-${date}-${Date.now()}`;
            card.innerHTML = `
                <div class="task-card-header"><h4 data-base-text="${baseText}"></h4><button class="minimize-btn">🔼</button></div>
                <div class="task-body">
                    <div class="info-field-container"><label>Descrizione:</label><textarea class="info-field descrizione-input" rows="2" placeholder="Descrizione..."></textarea></div>
                    <div class="content-tags"><button class="foto" data-type="foto">Foto</button><button class="video" data-type="video">Video</button><button class="grafico" data-type="grafico">Grafico</button><button class="titolo" data-type="titolo">Titolo</button><button class="cartina" data-type="cartina">Cartina</button><button class="project-tag">PO</button></div>
                    <div class="info-field-container"><label>Materiale:</label><textarea class="info-field materiale-input" rows="10" placeholder="Cosa, quando, ..."></textarea></div>
                    <div class="location-container">
                        <h5>Dove</h5>
                        <div class="location-buttons"><button class="location-btn" data-location="OpenMedia">in OpenMedia</button><button class="location-btn" data-location="Hive">in Hive</button></div>
                        <div class="location-text-container hidden"><input type="text" class="info-field location-text" placeholder="X Chi"></div>
                    </div>
                    <div class="request-status-container">
                        <div class="request-row"><button class="request-activation-btn" data-type="grafica">Richiesto in grafica</button><div class="request-status-indicator hidden"><span>Arrivato:</span><button class="status-toggle-btn" data-type="grafica" data-status="no">❌ No</button><input type="text" class="info-field grafica-contact-input" placeholder="Ev. contatto"></div></div>
                        <div class="request-row"><button class="request-activation-btn" data-type="ospite">Richiesto all'ospite</button><div class="request-status-indicator hidden"><span>Arrivato:</span><button class="status-toggle-btn" data-type="ospite" data-status="no">❌ No</button><input type="text" class="info-field ospite-contact-input" placeholder="Ev. contatto"></div></div>
                    </div>
                    <div class="info-field-container"><label>Links:</label><div class="links-container"></div></div>
                    <button class="add-link-btn">+</button>
                    <div class="task-buttons"><button class="edit-btn">✏️</button><button class="delete-btn">🗑️</button><button class="done-btn">✔️</button></div>
                </div>`;
            const linksContainer = card.querySelector('.links-container');
            const addLinkRow = (linkValue = '') => {
                const linkRow = document.createElement('div');
                linkRow.className = 'link-row';
                linkRow.innerHTML = `<input type="text" class="info-field link-input" placeholder="Link..." value="${sanitizeHTML(linkValue)}"><button class="remove-link-btn">🗑️</button>`;
                linksContainer.appendChild(linkRow);
                linkRow.querySelector('.remove-link-btn').addEventListener('click', () => { linkRow.remove(); saveTasks(activeDate); });
                linkRow.querySelector('.link-input').addEventListener('change', () => saveTasks(activeDate));
            };
            if (initialData.links && initialData.links.length > 0) initialData.links.forEach(link => addLinkRow(link)); else addLinkRow();
            card.querySelector('.add-link-btn').addEventListener('click', () => addLinkRow());
            if (initialData.isDone) card.classList.add('done');
            if (initialData.minimized) { card.classList.add('minimized'); card.querySelector('.minimize-btn').textContent = '🔽'; }
            if (initialData.projectTag) card.querySelector('.project-tag').textContent = initialData.projectTag;
            if (initialData.descrizione) card.querySelector('.descrizione-input').value = initialData.descrizione;
            if (initialData.materiale) card.querySelector('.materiale-input').value = initialData.materiale;
            if (initialData.location) { const locBtn = card.querySelector(`.location-btn[data-location="${initialData.location}"]`); if(locBtn) { locBtn.classList.add('active'); if(initialData.location === 'Hive') card.querySelector('.location-text-container').classList.remove('hidden'); } }
            if (initialData.locationText) card.querySelector('.location-text').value = initialData.locationText;
            if (initialData.activeTags) { initialData.activeTags.forEach(tagType => { const tagBtn = card.querySelector(`.content-tags button[data-type="${tagType}"]`); if (tagBtn) tagBtn.classList.add('active'); }); }
            if (initialData.grafica_active) {
                const activationBtn = card.querySelector('.request-activation-btn[data-type="grafica"]');
                activationBtn.classList.add('active'); activationBtn.nextElementSibling.classList.remove('hidden');
                if (initialData.grafica_status === 'yes') { const statusBtn = activationBtn.nextElementSibling.querySelector('.status-toggle-btn'); statusBtn.dataset.status = 'yes'; statusBtn.textContent = '✅ Sì'; }
                if(initialData.grafica_contatto) card.querySelector('.grafica-contact-input').value = initialData.grafica_contatto;
            }
            if (initialData.ospite_active) {
                const activationBtn = card.querySelector('.request-activation-btn[data-type="ospite"]');
                activationBtn.classList.add('active'); activationBtn.nextElementSibling.classList.remove('hidden');
                 if (initialData.ospite_status === 'yes') { const statusBtn = activationBtn.nextElementSibling.querySelector('.status-toggle-btn'); statusBtn.dataset.status = 'yes'; statusBtn.textContent = '✅ Sì'; }
                if(initialData.ospite_contatto) card.querySelector('.ospite-contact-input').value = initialData.ospite_contatto;
            }
            updateTitleWithPrefix(card);
            card.querySelector('h4').addEventListener('click', () => editTask(card));
            card.querySelector('.edit-btn').addEventListener('click', () => editTask(card));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteTask(card));
            card.querySelector('.done-btn').addEventListener('click', () => toggleDone(card));
            card.querySelector('.minimize-btn').addEventListener('click', () => toggleMinimize(card));
            card.querySelector('.project-tag').addEventListener('click', () => toggleProjectTag(card.querySelector('.project-tag')));
            card.querySelectorAll('.content-tags button:not(.project-tag)').forEach(button => button.addEventListener('click', () => toggleTag(button)));
            card.querySelectorAll('.location-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const wasActive = button.classList.contains('active');
                    card.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
                    if (!wasActive) button.classList.add('active');
                    const locationTextContainer = card.querySelector('.location-text-container');
                    if (button.dataset.location === 'Hive' && button.classList.contains('active')) { locationTextContainer.classList.remove('hidden'); } else { locationTextContainer.classList.add('hidden'); }
                    saveTasks(activeDate);
                });
            });
            card.querySelectorAll('.request-activation-btn').forEach(button => {
                button.addEventListener('click', () => { button.classList.toggle('active'); button.nextElementSibling.classList.toggle('hidden'); saveTasks(activeDate); });
            });
            card.querySelectorAll('.status-toggle-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const newStatus = button.dataset.status === 'no' ? 'yes' : 'no';
                    button.dataset.status = newStatus; button.textContent = newStatus === 'yes' ? '✅ Sì' : '❌ No';
                    saveTasks(activeDate);
                });
            });
            card.addEventListener('dragstart', dragStart); card.addEventListener('dragend', dragEnd);
            if (initialData.isDone) document.getElementById(`done-list-${date}`).appendChild(card);
            else if (initialData.parentId) document.getElementById(initialData.parentId).appendChild(card);
            else document.getElementById(`todo-list-${date}`).prepend(card);
            card.querySelectorAll('.info-field').forEach(input => { input.addEventListener('mousedown', e => e.stopPropagation()); input.addEventListener('change', () => saveTasks(date)); });
        }
        function dragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function dragEnd(e) { e.target.classList.remove('dragging'); }
        function dragOver(e) { e.preventDefault(); }
        function drop(e) {
            e.preventDefault();
            const cardId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.getElementById(cardId);
            const targetList = e.currentTarget;
            if (!draggedCard || !targetList.classList.contains('task-list')) return;
            const afterElement = getDragAfterElement(targetList, e.clientY);
            if (afterElement == null) targetList.appendChild(draggedCard);
            else targetList.insertBefore(draggedCard, afterElement);
            if (targetList.id.startsWith('done-list')) draggedCard.classList.add('done');
            else draggedCard.classList.remove('done');
            if (targetList.id.startsWith('in-progress-list')) { draggedCard.classList.add('minimized'); draggedCard.querySelector('.minimize-btn').textContent = '🔽'; }
            saveTasks(activeDate);
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function updateTitleWithPrefix(card) {
            const titleElement = card.querySelector('h4');
            const baseText = titleElement.dataset.baseText || '';
            const prefix = card.querySelector('.project-tag').textContent;
            titleElement.textContent = `${prefix}-${sanitizeHTML(baseText)}`;
        }
        function toggleMinimize(card) {
            const isMinimized = card.classList.toggle('minimized');
            card.querySelector('.minimize-btn').textContent = isMinimized ? '🔽' : '🔼';
            saveTasks(activeDate);
        }
        function editTask(card) {
            const titleElement = card.querySelector('h4');
            if (titleElement.isContentEditable) return;
            const taskButtons = card.querySelector('.task-buttons');
            card.setAttribute('draggable', 'false');
            titleElement.contentEditable = true;
            titleElement.textContent = titleElement.dataset.baseText;
            titleElement.focus();
            taskButtons.style.display = 'none';
            document.getSelection().selectAllChildren(titleElement);
            const finishEditing = () => {
                titleElement.contentEditable = false;
                taskButtons.style.display = 'flex';
                card.setAttribute('draggable', 'true');
                const newBaseText = titleElement.textContent.trim() || 'Nuovo task';
                titleElement.dataset.baseText = newBaseText;
                updateTitleWithPrefix(card);
                titleElement.removeEventListener('blur', finishEditing);
                titleElement.removeEventListener('keydown', handleKeyDown);
                saveTasks(activeDate);
            };
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') { e.preventDefault(); finishEditing(); } 
                else if (e.key === 'Escape') finishEditing();
            };
            titleElement.addEventListener('blur', finishEditing);
            titleElement.addEventListener('keydown', handleKeyDown);
        }
        function deleteTask(card) {
            if (confirm("Sei sicuro di voler eliminare questo compito?")) { card.remove(); saveTasks(activeDate); }
        }
        function toggleDone(card) {
            const isDone = card.classList.toggle('done');
            const targetList = isDone ? 'done-list' : 'todo-list';
            const minimizeBtn = card.querySelector('.minimize-btn');
            if (isDone) { card.classList.add('minimized'); minimizeBtn.textContent = '🔽'; } 
            else { card.classList.remove('minimized'); minimizeBtn.textContent = '🔼'; }
            document.getElementById(`${targetList}-${activeDate}`).appendChild(card);
            saveTasks(activeDate);
        }
        function toggleProjectTag(tagElement) {
            const card = tagElement.closest('.task-card');
            tagElement.textContent = tagElement.textContent === 'PO' ? 'QUOT' : 'PO';
            updateTitleWithPrefix(card);
            saveTasks(activeDate);
        }
        function toggleTag(button) { button.classList.toggle('active'); saveTasks(activeDate); }
        function serializeCard(card) {
            const graficaBtn = card.querySelector('.request-activation-btn[data-type="grafica"]');
            const ospiteBtn = card.querySelector('.request-activation-btn[data-type="ospite"]');
            const linkInputs = card.querySelectorAll('.links-container .link-input');
            const links = Array.from(linkInputs).map(input => input.value).filter(value => value.trim() !== '');

            return {
                id: card.id,
                text: card.querySelector('h4').dataset.baseText,
                descrizione: card.querySelector('.descrizione-input').value,
                projectTag: card.querySelector('.project-tag').textContent,
                materiale: card.querySelector('.materiale-input').value,
                links: links,
                location: card.querySelector('.location-btn.active')?.dataset.location || '',
                locationText: card.querySelector('.location-text').value,
                grafica_active: graficaBtn.classList.contains('active'),
                grafica_status: graficaBtn.nextElementSibling.querySelector('.status-toggle-btn').dataset.status,
                grafica_contatto: card.querySelector('.grafica-contact-input').value,
                ospite_active: ospiteBtn.classList.contains('active'),
                ospite_status: ospiteBtn.nextElementSibling.querySelector('.status-toggle-btn').dataset.status,
                ospite_contatto: card.querySelector('.ospite-contact-input').value,
                activeTags: Array.from(card.querySelectorAll('.content-tags button:not(.project-tag).active')).map(btn => btn.dataset.type),
                isDone: card.classList.contains('done'),
                minimized: card.classList.contains('minimized')
            };
        }
    </script>
</body>
</html>
