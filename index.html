<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Ora - Bacheca Lavoro</title>
    
    <link id="favicon" rel="icon" href="#">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        body{font-family:'Roboto',sans-serif;color:#333;margin:0;padding:2rem;display:flex;flex-direction:column;align-items:center}#background-video{position:fixed;left:0;bottom:0;min-width:100%;min-height:100%;width:auto;height:auto;z-index:-100;object-fit:cover}
        #presence-indicator{position:fixed;top:10px;left:10px;background-color:rgba(0,0,0,.4);color:#fff;padding:5px 10px;border-radius:5px;font-size:.8rem;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);z-index:1000;line-height:1.4}
        .fixed-controls{position:fixed;bottom:20px;right:20px;display:flex;gap:10px;z-index:1000}
        .fixed-controls button{padding:8px 15px;border-radius:5px;border:1px solid #fff;background-color:#2c3e50;color:#fff;font-weight:700;cursor:pointer;transition:background-color .2s;box-shadow:0 2px 5px rgba(0,0,0,.2)}.fixed-controls button:hover{background-color:#34495e}
        
        #app-container { display: none; width: 100%; flex-direction: column; align-items: center; }
        #auth-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 2rem; border-radius: 8px; width: 300px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); color: #eee; margin-top: 10vh; }
        .login-title { font-size: 2.5rem; font-weight: 700; color: #fff; text-align: center; margin: 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); }
        .login-subtitle { font-size: 1.1rem; color: #eee; text-align: center; margin: 0; line-height: 1.4; }
        #auth-container h2 { text-align: center; margin-top: 0; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input[type=password],
        .auth-form input[type=text]:not([id*="-email"]) { padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .email-input-container { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 5px; background-color: white; transition: border-color 0.2s, box-shadow 0.2s; }
        .email-input-container input[type=text] { border: none; flex-grow: 1; padding: 12px; font-size: 1rem; outline: none; background-color: transparent; min-width: 50px; }
        .email-suffix { padding: 12px; background-color: #eee; color: #555; font-size: 1rem; white-space: nowrap; border-radius: 0 4px 4px 0; border-left: 1px solid #ccc; }
        .email-input-container:focus-within { border-color: #3498db; box-shadow: 0 0 3px rgba(52,152,219,0.5); }
        .auth-form button { padding: 12px; border: none; border-radius: 5px; background-color: #3498db; color: white; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .auth-form button:hover { background-color: #2980b9; }
        .auth-toggle { text-align: center; margin-top: 1rem; font-size: 0.9rem; line-height: 1.5; }
        .auth-toggle a { color: #d93025; cursor: pointer; text-decoration: underline; }
        #auth-error { color: #e74c3c; text-align: center; margin-top: 1rem; font-weight: bold; }
        #auth-success { color: #2ecc71; text-align: center; margin-top: 1rem; font-weight: bold; }
        .rsi-red { color: #d93025; }

        .header-container{display:flex;justify-content:center;align-items:center;width:100%;max-width:1500px;margin-bottom:1rem;gap:1.5rem}
        .day-selector{display:flex;justify-content:center;flex-wrap:wrap;background-color:rgba(255,255,255,.2);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:.5rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05);flex-grow:1}.day-selector button{backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.8);border-radius:5px;padding:8px 12px;margin:5px;font-size:.8rem;cursor:pointer;transition:background-color .2s,color .2s,border-color .2s;color:#fff;font-weight:700}.day-color-0{background-color:rgba(255,179,186,.7)}.day-color-1{background-color:rgba(255,223,186,.7)}.day-color-2{background-color:rgba(255,255,186,.7)}.day-color-3{background-color:rgba(186,255,201,.7)}.day-color-4{background-color:rgba(186,225,255,.7)}.day-color-5{background-color:rgba(215,186,255,.7)}.day-color-6{background-color:rgba(255,186,236,.7)}.day-selector button.active{background-color:#2c3e50;color:#fff;border-color:#fff}
        .daily-info-container{display:flex;flex-direction:column;gap:6px;background-color:rgba(0,0,0,.2);padding:8px 12px;border-radius:8px;flex-shrink:0}
        .info-row{display:flex;align-items:center;gap:8px}
        .daily-info-container label{font-weight:700;color:#fff;text-shadow:1px 1px 2px #000;width:80px;text-align:right;font-size:0.8rem}
        .daily-info-container input{padding:6px;border-radius:5px;border:1px solid #777;width:120px;font-size:0.8rem}
        .kanban-board{display:flex;gap:2rem;justify-content:center;width:100%;max-width:1400px}
        .column{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);padding:1.5rem;border-radius:8px;width:300px;min-height:500px;box-shadow:0 4px 30px rgba(0,0,0,.1);display:flex;flex-direction:column}.column.done-column{width:250px}.column-header{font-size:1.5rem;font-weight:700;margin-top:0;margin-bottom:1rem;color:#eee;text-shadow:1px 1px 3px rgba(0,0,0,.4);text-align:center}.add-task{display:flex;margin-bottom:1rem}.add-task input{flex-grow:1;padding:10px;border:1px solid #ccc;border-radius:5px;font-size:.9rem}.add-task button{padding:10px 15px;border:none;background-color:#2c3e50;color:#fff;border-radius:5px;margin-left:5px;cursor:pointer;font-size:.9rem}.task-list{flex-grow:1;overflow-y:auto;position:relative;min-height:100px}.task-card{background:rgba(255,255,255,.2);padding:1rem;border-radius:5px;margin-bottom:1rem;cursor:grab;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;position:relative}.task-card:active{cursor:grabbing}.task-card.dragging{opacity:.5;box-shadow:0 4px 15px rgba(0,0,0,.2);transform:scale(1.05)}
        .task-card.done{background:rgba(46,204,113,.2)}
        
        .task-meta-info{font-size:0.65rem;color:#f0f0f0;margin-bottom:8px;margin-top:-8px;text-shadow:1px 1px 1px rgba(0,0,0,0.3);}
        
        .task-card-header{display:flex;justify-content:space-between;align-items:center}.task-card h4{margin:0 0 .5rem;font-size:1.1rem;flex-grow:1;cursor:text;transition:background-color .2s ease-in-out;color:#fff;padding:4px 10px;border-radius:15px;display:inline-block;width:auto}.task-card h4[contenteditable=true]{background-color:rgba(255,255,255,.8) !important;outline:2px solid #3498db;color:#333 !important}.info-field-container{margin-top:10px}.info-field-container label{font-size:.9rem;font-weight:700;color:#444;display:block;margin-bottom:5px}.info-field{width:calc(100% - 10px);padding:5px;border:1px solid #ccc;border-radius:3px;font-size:.9rem;resize:vertical;font-family:inherit}.task-card .task-buttons{display:flex;justify-content:space-between;margin-top:1rem}.task-card .task-buttons button,.minimize-btn{background:0 0;border:none;cursor:pointer;font-size:1.2rem;color:#333;transition:color .2s}.minimize-btn{font-size:1rem;margin-left:10px;padding:0 5px}.task-card .task-buttons button:hover,.minimize-btn:hover{color:#000}
        
        .task-card.minimized .task-body{display:none}
        .task-card.minimized h4{margin-bottom:0}
        .task-card.minimized .task-meta-info { display: none; }

        .content-tags button{padding:5px 10px;border-radius:20px;border:none;cursor:pointer;color:#fff;font-size:.8rem;margin-right:5px;margin-bottom:5px;opacity:.6;transition:opacity .2s,filter .2s;filter:grayscale(20%)}.content-tags button.active{opacity:1;filter:grayscale(0%)}
        
        .content-tags .foto{background-color:#FF7F50}.content-tags .clip{background-color:#337AB7}.content-tags .copertura{background-color:#6A5ACD}.content-tags .grafico{background-color:#28A745}.content-tags .oggetto{background-color:#FFC107}.content-tags .cartina{background-color:#8B4513}.project-tag{padding:5px 10px;border-radius:20px;border:1px solid #ccc;cursor:pointer;font-size:.8rem;margin-right:5px;margin-bottom:5px;background-color:#2c3e50;color:#fff}
        .location-container h5{margin:.8rem 0 .5rem;font-size:1rem;color:#444}.location-buttons{display:flex;gap:10px;margin-bottom:.5rem}.location-btn{padding:5px 10px;font-size:.8rem;border-radius:5px;border:1px solid #aaa;background-color:#eee;cursor:pointer}.location-btn.active{background-color:#3498db;color:#fff;border-color:#3498db}
        .request-status-container{margin-top:15px;border-top:1px solid rgba(0,0,0,.1);padding-top:15px;display:flex;flex-direction:column;gap:15px}
        .request-row{display:block}.request-activation-btn{margin-bottom:8px}
        .request-status-indicator{display:flex;align-items:center;gap:5px;flex-grow:1;flex-wrap:wrap}.request-status-indicator span{font-size:.9rem;font-weight:700;color:#444;flex-shrink:0}
        .request-activation-btn{padding:5px 10px;font-size:.9rem;border-radius:5px;border:1px solid #aaa;background-color:#eee;cursor:pointer;transition:all .2s}.request-activation-btn.active{background-color:#3498db;color:#fff;border-color:#3498db}
        .status-toggle-btn{padding:4px 8px;font-size:.8rem;border-radius:5px;border:1px solid;cursor:pointer;transition:background-color .2s,color .2s,border-color .2s;flex-shrink:0}.status-toggle-btn[data-status=no]{background-color:rgba(231,76,60,.1);color:#c0392b;border-color:#e74c3c}.status-toggle-btn[data-status=yes]{background-color:rgba(46,204,113,.2);color:#27ae60;border-color:#2ecc71}
        .hidden{display:none !important}
        .link-row{display:flex;align-items:center;gap:5px;margin-bottom:5px}.link-row input{flex-grow:1}.remove-link-btn{background:0 0;border:none;cursor:pointer;font-size:1.2rem;color:#888;padding:0 5px}.remove-link-btn:hover{color:#000}
        .add-link-btn{width:30px;height:30px;margin-top:5px;padding:0;font-size:1.2rem;font-weight:700;color:#3498db;background-color:rgba(255,255,255,.4);border:1px dashed #3498db;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        @media (max-width:1300px){.kanban-board{flex-direction:column;align-items:center}}
        @media (max-width:900px){.kanban-board{flex-direction:column;align-items:center}.column{width:100%;max-width:400px;margin-bottom:20px}.header-container{flex-direction:column;align-items:stretch}}
    </style>
</head>
<body>
    <video autoplay muted loop id="background-video">
        <source src="background.mp4" type="video/mp4">
        Il tuo browser non supporta il tag video.
    </video>
    
    <div id="presence-indicator" class="hidden">Connessione...</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD3Ry99dV34fUo6NfzZ5ykSjPcJN1gl8mk", authDomain: "prima-ora-task-registi.firebaseapp.com", projectId: "prima-ora-task-registi", storageBucket: "prima-ora-task-registi.firebasestorage.app", messagingSenderId: "1090920780195", appId: "1:1090920780195:web:89059a93c18fc97bc08a16", databaseURL: "https://prima-ora-task-registi-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const auth = firebase.auth();
    </script>

    <div id="auth-container">
        <h1 class="login-title">Prepara<span class="rsi-red">RSI</span></h1>
        <br>
        <p class="login-subtitle">Task registi Prima Ora</p>
        <br>
        <p class="login-subtitle" style="margin: 0;">Benvenuto!</p>
        <br>
        
        <div id="login-form">
            <h2>Accedi</h2>
            <form class="auth-form" onsubmit="handleLogin(event)">
                <div class="email-input-container">
                    <input type="text" id="login-email" placeholder="nome.cognome" required>
                    <span class="email-suffix">@rsi.ch</span>
                </div>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Accedi</button>
            </form>
            <div class="auth-toggle">
                Non hai un account? <a onclick="toggleAuthForm(true)">Registrati</a>
                <br>
                <a onclick="showPasswordReset()">Password dimenticata?</a>
            </div>
        </div>

        <div id="register-form" class="hidden">
            <h2>Registrati</h2>
            <form class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="register-nome" placeholder="Nome" required>
                <input type="text" id="register-cognome" placeholder="Cognome" required>
                <div class="email-input-container">
                    <input type="text" id="register-email" placeholder="nome.cognome" required>
                    <span class="email-suffix">@rsi.ch</span>
                </div>
                <input type="password" id="register-password" placeholder="Password (min. 6 caratteri)" required>
                <input type="password" id="register-password-confirm" placeholder="Conferma Password" required>
                <button type="submit">Registrati</button>
            </form>
            <div class="auth-toggle">
                Hai gi√† un account? <a onclick="toggleAuthForm(false)">Accedi</a>
            </div>
        </div>

        <div id="reset-form" class="hidden">
            <h2>Recupera Password</h2>
            <form class="auth-form" onsubmit="handlePasswordReset(event)">
                <div class="email-input-container">
                    <input type="text" id="reset-email" placeholder="nome.cognome" required>
                    <span class="email-suffix">@rsi.ch</span>
                </div>
                <button type="submit">Invia link di recupero</button>
            </form>
            <div class="auth-toggle">
                Tornare al <a onclick="showLoginFromReset()">Login</a>
            </div>
        </div>

        <div id="auth-error" class="hidden"></div>
        <div id="auth-success" class="hidden"></div>
    </div>

    <div id="app-container">
        <div class="header-container">
             <div class="daily-info-container">
                <div class="info-row"><label for="ce-input">CE:</label><input type="text" id="ce-input" class="daily-input" placeholder="Nome..."></div>
                <div class="info-row"><label for="conducono1-input">Conducono:</label><input type="text" id="conducono1-input" class="daily-input" placeholder="Nome..."></div>
                <div class="info-row"><label for="conducono2-input"></label><input type="text" id="conducono2-input" class="daily-input" placeholder="Nome..."></div>
             </div>
             <div class="day-selector" id="day-selector"></div>
        </div>
        <div id="kanban-container"></div>
    </div>
    
    <div class="fixed-controls">
        <button id="export-btn" class="hidden">Esporta dati</button>
        <button id="import-btn" class="hidden">Importa dati</button>
        <input type="file" id="import-file-input" accept=".json" style="display: none;">
        <button id="logout-btn" class="hidden" onclick="handleLogout()">Logout</button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setupAuth();
            const nomeInput = document.getElementById('register-nome');
            const cognomeInput = document.getElementById('register-cognome');
            const emailInput = document.getElementById('register-email');
            function updateEmail() {
                const nome = nomeInput.value.toLowerCase().trim().replace(/\s+/g, '');
                const cognome = cognomeInput.value.toLowerCase().trim().replace(/\s+/g, '');
                let emailBase = '';
                if (nome && cognome) { emailBase = `${nome}.${cognome}`; } 
                else if (nome) { emailBase = nome; } 
                else if (cognome) { emailBase = cognome; }
                emailInput.value = emailBase;
            }
            nomeInput.addEventListener('input', updateEmail);
            cognomeInput.addEventListener('input', updateEmail);
        });

        const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
        const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        let activeDate = '';
        let unsubscribeTasks = null;
        let unsubscribeDailyInfo = null;
        let currentDailyInfoKey = null;

        // --- NUOVI FLAG DI CONTROLLO PER IL "FLASH" ---
        let isAppInitialized = false; 
        let isRegistering = false;
        let isLoggingIn = false;
        // ---------------------------------------------

        // --- FUNZIONE setupAuth MODIFICATA ---
        function setupAuth() {
            auth.onAuthStateChanged(user => {
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');
                const logoutBtn = document.getElementById('logout-btn');
                const presenceIndicator = document.getElementById('presence-indicator');
                const exportBtn = document.getElementById('export-btn');
                const importBtn = document.getElementById('import-btn');

                // Controlla tutti i flag per prevenire il "flash"
                if (user && !isAppInitialized && !isRegistering && !isLoggingIn) {
                    isAppInitialized = true; 
                    
                    authContainer.classList.add('hidden');
                    appContainer.style.display = 'flex';
                    logoutBtn.classList.remove('hidden');
                    presenceIndicator.classList.remove('hidden');
                    exportBtn.classList.remove('hidden');
                    importBtn.classList.remove('hidden');
                    
                    const daysToDisplay = 8;
                    generateDaySelectors(daysToDisplay);
                    
                    switchDay(new Date().toISOString().split('T')[0]);
                    
                    document.querySelectorAll('.daily-info-container input').forEach(input => {
                        input.addEventListener('change', () => saveTasks(activeDate));
                    });

                    document.getElementById('export-btn').addEventListener('click', exportData);
                    const importFileInput = document.getElementById('import-file-input');
                    document.getElementById('import-btn').addEventListener('click', () => importFileInput.click());
                    importFileInput.addEventListener('change', importData);
                    animateFavicon();
                    setupPresence();
                } else if (!user) { 
                    // Resetta tutti i flag quando l'utente non c'√®
                    isAppInitialized = false; 
                    isRegistering = false;
                    isLoggingIn = false;
                    
                    authContainer.classList.remove('hidden');
                    appContainer.style.display = 'none';
                    logoutBtn.classList.add('hidden');
                    presenceIndicator.classList.add('hidden');
                    exportBtn.classList.add('hidden');
                    importBtn.classList.add('hidden');
                    
                    if (unsubscribeTasks) unsubscribeTasks();
                    if (unsubscribeDailyInfo) unsubscribeDailyInfo();
                    if (rtdb) rtdb.ref('/presence').off(); // Stacca il listener della presence

                    document.getElementById('day-selector').innerHTML = '';
                    document.getElementById('kanban-container').innerHTML = '';
                }
            });
        }
        // --- FINE setupAuth ---

        function toggleAuthForm(showRegister) {
            document.getElementById('login-form').classList.toggle('hidden', showRegister);
            document.getElementById('register-form').classList.toggle('hidden', !showRegister);
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-success').classList.add('hidden');
        }
        function showPasswordReset() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-success').classList.add('hidden');
        }
        function showLoginFromReset() {
            toggleAuthForm(false);
        }

        // --- FUNZIONE handleLogin MODIFICATA ---
        function handleLogin(event) {
            event.preventDefault();
            isLoggingIn = true; // <-- Flag ON
            
            const email = document.getElementById('login-email').value + '@rsi.ch';
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('hidden');
            document.getElementById('auth-success').classList.add('hidden');
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Metti il codice di produzione (non il test 'if (false)')
                    if (user.emailVerified) {
                        // OK, l'utente √® verificato
                        isLoggingIn = false; // <-- Flag OFF
                        // setupAuth si attiver√† al prossimo "tick" e far√† entrare l'utente
                    } else {
                        // Email non verificata!
                        auth.signOut(); // Disconnette (triggera setupAuth)
                        errorDiv.textContent = "Account non ancora attivo. Controlla la tua email per il link di verifica.";
                        errorDiv.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    isLoggingIn = false; // <-- Flag OFF
                    errorDiv.textContent = "Utente o password non validi.";
                    errorDiv.classList.remove('hidden');
                });
        }
        // --- FINE handleLogin ---

        // --- FUNZIONE handleRegister MODIFICATA ---
        function handleRegister(event) {
            event.preventDefault();
            isRegistering = true; // <-- Flag ON
            
            const email = document.getElementById('register-email').value + '@rsi.ch';
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;
            const nome = document.getElementById('register-nome').value;
            const cognome = document.getElementById('register-cognome').value;
            const displayName = `${nome} ${cognome.charAt(0)}.`;
            
            const errorDiv = document.getElementById('auth-error');
            const successDiv = document.getElementById('auth-success');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            if (password !== confirmPassword) {
                errorDiv.textContent = "Le password non coincidono.";
                errorDiv.classList.remove('hidden');
                isRegistering = false; // <-- Flag OFF
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return user.sendEmailVerification().then(() => {
                        return user.updateProfile({
                            displayName: displayName
                        }).then(() => {
                            return db.collection('users').doc(user.uid).set({
                                nome: nome,
                                cognome: cognome,
                                displayName: displayName,
                                email: user.email
                            });
                        });
                    });
                })
                .then(() => {
                    auth.signOut(); // Forza il logout
                    isRegistering = false; // <-- Flag OFF
                    
                    successDiv.textContent = "Registrazione completata! Controlla la tua email per il link di attivazione e poi accedi.";
                    successDiv.classList.remove('hidden');
                    toggleAuthForm(false); 
                })
                .catch(error => {
                    isRegistering = false; // <-- Flag OFF
                    
                    if (error.code === 'auth/email-already-in-use') {
                        errorDiv.textContent = "Questa email √® gi√† registrata. Prova ad accedere.";
                    } else if (error.code === 'auth/weak-password') {
                        errorDiv.textContent = "La password √® troppo debole (min. 6 caratteri).";
                    } else {
                        errorDiv.textContent = "Errore: " + error.message;
                    }
                    errorDiv.classList.remove('hidden');
                });
        }
        // --- FINE handleRegister ---

        function handlePasswordReset(event) {
            event.preventDefault();
            const email = document.getElementById('reset-email').value + '@rsi.ch';
            const errorDiv = document.getElementById('auth-error');
            const successDiv = document.getElementById('auth-success');
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    successDiv.textContent = "Se un account con questa email √® registrato, riceverai un link di recupero.";
                    successDiv.classList.remove('hidden');
                })
                .catch((error) => {
                    successDiv.textContent = "Se un account con questa email √® registrato, riceverai un link di recupero.";
                    successDiv.classList.remove('hidden');
                });
        }
        
        function handleLogout() {
            if (auth.currentUser) {
                const myUid = auth.currentUser.uid;
                rtdb.ref('/presence/' + myUid).remove();
            }
            auth.signOut(); // Questo triggera onAuthStateChanged, che resetta tutto
        }
        // --- FINE FUNZIONI DI AUTENTICAZIONE ---

        function getDailyInfoKey(dateString) {
            const date = new Date(dateString + 'T12:00:00Z');
            let dayOfWeek = date.getUTCDay();
            if (dayOfWeek === 0) dayOfWeek = 7;
            let keyDate = new Date(date);
            if (dayOfWeek >= 1 && dayOfWeek <= 3) { keyDate.setUTCDate(keyDate.getUTCDate() - (dayOfWeek - 1)); }
            else if (dayOfWeek >= 4 && dayOfWeek <= 5) { keyDate.setUTCDate(keyDate.getUTCDate() - (dayOfWeek - 4)); }
            else { keyDate.setUTCDate(keyDate.getUTCDate() - (dayOfWeek - 6)); }
            return keyDate.toISOString().split('T')[0];
        }
        
        function setupPresence() {
            const myUid = auth.currentUser.uid;
            const myDisplayName = auth.currentUser.displayName || 'Anonimo';
            const presenceRef = rtdb.ref('/presence/' + myUid);
            const getLocation = async () => {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    return { city: data.city, country: data.country_code };
                } catch (error) {
                    console.error("Errore geo-loc:", error);
                    return { city: 'Sconosciuto', country: 'N/A' };
                }
            };
            rtdb.ref('.info/connected').on('value', async (snap) => {
                if (snap.val() === true) {
                    const location = await getLocation();
                    presenceRef.set({ 
                        online: true, 
                        location: `${location.city}, ${location.country}`,
                        name: myDisplayName
                    });
                    presenceRef.onDisconnect().remove();
                }
            });
            rtdb.ref('/presence').on('value', (snapshot) => {
                const presenceIndicator = document.getElementById('presence-indicator');
                const userCount = snapshot.numChildren();
                const locations = new Set();
                snapshot.forEach(childSnapshot => {
                    const userData = childSnapshot.val();
                    if (userData.location) locations.add(userData.location);
                });
                const locationsArray = [...locations];
                let locationsHtml;
                if (locationsArray.length > 1) {
                    locationsHtml = '<br>' + locationsArray.join('<br>');
                } else {
                    locationsHtml = ` (${locationsArray.join(', ') || 'N/A'})`;
                }
                presenceIndicator.innerHTML = `Utenti connessi: ${userCount}${locationsHtml}`;
            });
        }
        
        function animateFavicon() {
            const favicon = document.getElementById('favicon');
            if (!favicon) return;
            const icons = ['üïï', 'üì°'];
            let counter = 0;
            setInterval(() => {
                const emoji = icons[counter % icons.length];
                const newHref = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>${emoji}</text></svg>`;
                favicon.setAttribute('href', newHref);
                counter++;
            }, 1500);
        }

        function sanitizeHTML(str) { if (!str) return ''; return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }

        function exportData() {
            const dateToExp = activeDate;
            if(!dateToExp) { alert("Seleziona un giorno da esportare."); return; }
            db.collection('bacheche').doc(dateToExp).get().then(doc => {
                if (!doc.exists) { alert("Nessun dato da esportare per questo giorno."); return; }
                const dataToExport = doc.data();
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup-bacheca-${dateToExp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            });
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const dateFromFile = file.name.replace('backup-bacheca-', '').replace('.json', '');
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateFromFile)) { alert("Nome del file non valido."); return; }
            if (!confirm(`ATTENZIONE: Stai per sovrascrivere i dati del giorno ${dateFromFile}. Vuoi continuare?`)) { event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    db.collection('bacheche').doc(dateFromFile).set(importedData).then(() => { alert(`Dati per il giorno ${dateFromFile} importati con successo!`); });
                } catch (error) {
                    alert('Errore: Il file selezionato non √® valido o √® corrotto.');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function generateDaySelectors(count) {
            const selectorContainer = document.getElementById('day-selector');
            const kanbanContainer = document.getElementById('kanban-container');
            const today = new Date();
            for (let i = -2; i < count - 2; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() + i);
                const dateString = day.toISOString().split('T')[0];
                const buttonText = `${dayNames[day.getDay()]} ${day.getDate()} ${monthNames[day.getMonth()]}`;
                const button = document.createElement('button');
                button.textContent = buttonText; button.setAttribute('data-date', dateString); button.classList.add(`day-color-${day.getDay()}`); button.addEventListener('click', () => switchDay(dateString));
                selectorContainer.appendChild(button);
                const kanbanBoard = document.createElement('div');
                kanbanBoard.id = `board-${dateString}`; kanbanBoard.className = 'kanban-board'; kanbanBoard.style.display = 'none';
                kanbanBoard.innerHTML = `
                    <div class="column" id="comms-column-${dateString}"><h2 class="column-header">Comunicazioni importanti</h2><textarea class="info-field comms-field-1" rows="25" placeholder="Descrizione"></textarea></div>
                    <div class="column" id="todo-column-${dateString}"><h2 class="column-header">üìù Da fare</h2><div class="add-task"><input type="text" id="todo-input-${dateString}" placeholder="Aggiungi nuovo compito..."><button class="add-btn" data-date="${dateString}">Aggiungi</button></div><div class="task-list" id="todo-list-${dateString}"></div></div>
                    <div class="column" id="in-progress-column-${dateString}"><h2 class="column-header">‚è≥ In corso</h2><div class="task-list" id="in-progress-list-${dateString}"></div></div>
                    <div class="column done-column" id="done-column-${dateString}"><h2 class="column-header">‚úÖ Pronti</h2><div class="task-list" id="done-list-${dateString}"></div></div>`;
                kanbanContainer.appendChild(kanbanBoard);
                kanbanBoard.querySelector('.add-btn').addEventListener('click', () => {
                    const input = document.getElementById(`todo-input-${dateString}`);
                    if (input.value.trim() !== '') { createTaskCard(input.value, {}, dateString); input.value = ''; saveTasks(dateString); }
                });
                kanbanBoard.querySelector('.comms-field-1').addEventListener('change', () => saveTasks(dateString));
                kanbanBoard.querySelectorAll('.task-list').forEach(list => { list.addEventListener('dragover', dragOver); list.addEventListener('drop', drop); });
            }
        }
        
        function switchDay(date) {
            document.querySelectorAll('.day-selector button').forEach(btn => { btn.classList.toggle('active', btn.getAttribute('data-date') === date); });
            document.querySelectorAll('.kanban-board').forEach(board => { board.style.display = 'none'; });
            document.getElementById(`board-${date}`).style.display = 'flex';
            activeDate = date;

            if (unsubscribeTasks) unsubscribeTasks();
            unsubscribeTasks = db.collection('bacheche').doc(activeDate).onSnapshot(snapshot => {
                ['todo', 'in-progress', 'done'].forEach(type => { const list = document.getElementById(`${type}-list-${activeDate}`); if (list) list.innerHTML = ''; });
                const data = snapshot.data();
                if (data) {
                    const comms1 = document.querySelector(`#board-${activeDate} .comms-field-1`);
                    if(comms1) comms1.value = data.comunicazione1 || '';
                    data.todo?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `todo-list-${activeDate}` }));
                    data.inProgress?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `in-progress-list-${activeDate}` }));
                    data.done?.forEach(taskData => createTaskCard(taskData.text, { ...taskData, parentId: `done-list-${activeDate}` }));
                }
            });

            const newDailyInfoKey = getDailyInfoKey(date);
            if (newDailyInfoKey !== currentDailyInfoKey) {
                currentDailyInfoKey = newDailyInfoKey;
                if (unsubscribeDailyInfo) unsubscribeDailyInfo();
                unsubscribeDailyInfo = db.collection('daily_info').doc(currentDailyInfoKey).onSnapshot(snapshot => {
                    const data = snapshot.data();
                    document.getElementById('ce-input').value = data?.ce || '';
                    document.getElementById('conducono1-input').value = data?.conducono1 || '';
                    document.getElementById('conducono2-input').value = data?.conducono2 || '';
                });
            }
        }
        
        function saveTasks(date) {
            if (!date) return;
            const dailyInfoKey = getDailyInfoKey(date);
            const dailyInfo = { 
                ce: document.getElementById('ce-input').value || '',
                conducono1: document.getElementById('conducono1-input').value || '',
                conducono2: document.getElementById('conducono2-input').value || ''
            };
            db.collection('daily_info').doc(dailyInfoKey).set(dailyInfo);
            const tasks = { 
                comunicazione1: document.querySelector(`#board-${date} .comms-field-1`)?.value || '',
                todo: [], inProgress: [], done: [] 
            };
            document.querySelectorAll(`#todo-list-${date} .task-card`).forEach(card => tasks.todo.push(serializeCard(card)));
            document.querySelectorAll(`#in-progress-list-${date} .task-card`).forEach(card => tasks.inProgress.push(serializeCard(card)));
            document.querySelectorAll(`#done-list-${date} .task-card`).forEach(card => tasks.done.push(serializeCard(card)));
            db.collection('bacheche').doc(date).set(tasks);
        }

        function createTaskCard(baseText, initialData = {}, date = activeDate) {
            const card = document.createElement('div');
            card.className = 'task-card'; card.setAttribute('draggable', 'true'); card.id = initialData.id || `task-${date}-${Date.now()}`;
            
            if (!initialData.createdBy) initialData.createdBy = auth.currentUser.displayName || 'Utente';
            if (!initialData.lastModifiedBy) initialData.lastModifiedBy = initialData.createdBy;
            card.dataset.createdBy = initialData.createdBy;

            card.innerHTML = `
                <div class="task-meta-info">Creato da: ${sanitizeHTML(initialData.createdBy)} | Ultima mod.: ${sanitizeHTML(initialData.lastModifiedBy)}</div>
                <div class="task-card-header"><h4 data-base-text="${baseText}"></h4><button class="minimize-btn">üîº</button></div>
                <div class="task-body">
                    <div class="info-field-container"><label>Descrizione:</label><textarea class="info-field descrizione-input" rows="2" placeholder="Descrizione..."></textarea></div>
                    <div class="content-tags"><button class="foto" data-type="foto">Foto</button><button class="clip" data-type="clip">Clip</button><button class="copertura" data-type="copertura">Copertura</button><button class="grafico" data-type="grafico">Grafico</button><button class="oggetto" data-type="oggetto">Oggetto</button><button class="cartina" data-type="cartina">Cartina</button><button class="project-tag">PO</button></div>
                    <div class="info-field-container"><label>Materiale:</label><textarea class="info-field materiale-input" rows="10" placeholder="Cosa, quando, ..."></textarea></div>
                    <div class="location-container">
                        <h5>Dove</h5>
                        <div class="location-buttons"><button class="location-btn" data-location="OpenMedia">in OpenMedia</button><button class="location-btn" data-location="Hive">in Hive</button></div>
                        <div class="location-text-container hidden"><input type="text" class="info-field location-text" placeholder="X Chi"></div>
                    </div>
                    <div class="request-status-container">
                        <div class="request-row"><button class="request-activation-btn" data-type="grafica">Richiesto in grafica</button><div class="request-status-indicator hidden"><span>Arrivato:</span><button class="status-toggle-btn" data-type="grafica" data-status="no">‚ùå No</button><input type="text" class="info-field grafica-contact-input" placeholder="Ev. contatto"></div></div>
                        <div class="request-row"><button class="request-activation-btn" data-type="ospite">Richiesto all'ospite</button><div class="request-status-indicator hidden"><span>Arrivato:</span><button class="status-toggle-btn" data-type="ospite" data-status="no">‚ùå No</button><input type="text" class="info-field ospite-contact-input" placeholder="Ev. contatto"></div></div>
                    </div>
                    <div class="info-field-container"><label>Links:</label><div class="links-container"></div></div>
                    <button class="add-link-btn">+</button>
                    <div class="task-buttons"><button class="edit-btn">‚úèÔ∏è</button><button class="delete-btn">üóëÔ∏è</button><button class="done-btn">‚úîÔ∏è</button></div>
                </div>`;
            
            const linksContainer = card.querySelector('.links-container');
            const addLinkRow = (linkValue = '') => {
                const linkRow = document.createElement('div');
                linkRow.className = 'link-row';
                linkRow.innerHTML = `<input type="text" class="info-field link-input" placeholder="Link..." value="${sanitizeHTML(linkValue)}"><button class="remove-link-btn">üóëÔ∏è</button>`;
                linksContainer.appendChild(linkRow);
                linkRow.querySelector('.remove-link-btn').addEventListener('click', () => { linkRow.remove(); saveTasks(activeDate); });
                linkRow.querySelector('.link-input').addEventListener('change', () => saveTasks(activeDate));
            };
            if (initialData.links && initialData.links.length > 0) initialData.links.forEach(link => addLinkRow(link)); else addLinkRow();
            card.querySelector('.add-link-btn').addEventListener('click', () => addLinkRow());
            if (initialData.isDone) card.classList.add('done');
            if (initialData.minimized) { card.classList.add('minimized'); card.querySelector('.minimize-btn').textContent = 'üîΩ'; }
            if (initialData.projectTag) card.querySelector('.project-tag').textContent = initialData.projectTag;
            if (initialData.descrizione) card.querySelector('.descrizione-input').value = initialData.descrizione;
            if (initialData.materiale) card.querySelector('.materiale-input').value = initialData.materiale;
            if (initialData.location) { const locBtn = card.querySelector(`.location-btn[data-location="${initialData.location}"]`); if(locBtn) { locBtn.classList.add('active'); if(initialData.location === 'Hive') card.querySelector('.location-text-container').classList.remove('hidden'); } }
            if (initialData.locationText) card.querySelector('.location-text').value = initialData.locationText;
            if (initialData.activeContentTag) { const tagBtn = card.querySelector(`.content-tags button[data-type="${initialData.activeContentTag}"]`); if (tagBtn) tagBtn.classList.add('active'); }
            if (initialData.grafica_active) {
                const activationBtn = card.querySelector('.request-activation-btn[data-type="grafica"]');
                activationBtn.classList.add('active'); activationBtn.nextElementSibling.classList.remove('hidden');
                if (initialData.grafica_status === 'yes') { const statusBtn = activationBtn.nextElementSibling.querySelector('.status-toggle-btn'); statusBtn.dataset.status = 'yes'; statusBtn.textContent = '‚úÖ S√¨'; }
                if(initialData.grafica_contatto) card.querySelector('.grafica-contact-input').value = initialData.grafica_contatto;
            }
            if (initialData.ospite_active) {
                const activationBtn = card.querySelector('.request-activation-btn[data-type="ospite"]');
                activationBtn.classList.add('active'); activationBtn.nextElementSibling.classList.remove('hidden');
                 if (initialData.ospite_status === 'yes') { const statusBtn = activationBtn.nextElementSibling.querySelector('.status-toggle-btn'); statusBtn.dataset.status = 'yes'; statusBtn.textContent = '‚úÖ S√¨'; }
                if(initialData.ospite_contatto) card.querySelector('.ospite-contact-input').value = initialData.ospite_contatto;
            }
            updateTitleWithPrefixAndColor(card);
            card.querySelector('h4').addEventListener('click', () => editTask(card));
            card.querySelector('.edit-btn').addEventListener('click', () => editTask(card));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteTask(card));
            card.querySelector('.done-btn').addEventListener('click', () => toggleDone(card));
            card.querySelector('.minimize-btn').addEventListener('click', () => toggleMinimize(card));
            card.querySelector('.project-tag').addEventListener('click', () => toggleProjectTag(card.querySelector('.project-tag')));
            card.querySelectorAll('.content-tags button:not(.project-tag)').forEach(button => button.addEventListener('click', () => toggleTag(button, card)));
            card.querySelectorAll('.location-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const wasActive = button.classList.contains('active');
                    card.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
                    if (!wasActive) button.classList.add('active');
                    const locationTextContainer = card.querySelector('.location-text-container');
                    if (button.dataset.location === 'Hive' && button.classList.contains('active')) { locationTextContainer.classList.remove('hidden'); } else { locationTextContainer.classList.add('hidden'); }
                    saveTasks(activeDate);
                });
            });
             card.querySelectorAll('.request-activation-btn').forEach(button => {
                 button.addEventListener('click', () => { button.classList.toggle('active'); button.nextElementSibling.classList.toggle('hidden'); saveTasks(activeDate); });
            });
             card.querySelectorAll('.status-toggle-btn').forEach(button => {
                 button.addEventListener('click', () => {
                     const newStatus = button.dataset.status === 'no' ? 'yes' : 'no';
                     button.dataset.status = newStatus; button.textContent = newStatus === 'yes' ? '‚úÖ S√¨' : '‚ùå No';
                     saveTasks(activeDate);
                 });
            });
            card.addEventListener('dragstart', dragStart); card.addEventListener('dragend', dragEnd);
            if (initialData.isDone) document.getElementById(`done-list-${date}`).appendChild(card);
            else if (initialData.parentId) document.getElementById(initialData.parentId).appendChild(card);
            else document.getElementById(`todo-list-${date}`).prepend(card);
            card.querySelectorAll('.info-field').forEach(input => { input.addEventListener('mousedown', e => e.stopPropagation()); input.addEventListener('change', () => saveTasks(date)); });
        }
        function dragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function dragEnd(e) { e.target.classList.remove('dragging'); }
        function dragOver(e) { e.preventDefault(); }
        function drop(e) {
            e.preventDefault();
            const cardId = e.dataTransfer.getData('text/plain');
            const draggedCard = document.getElementById(cardId);
            const targetList = e.currentTarget;
            if (!draggedCard || !targetList.classList.contains('task-list')) return;
            const afterElement = getDragAfterElement(targetList, e.clientY);
            if (afterElement == null) targetList.appendChild(draggedCard);
            else targetList.insertBefore(draggedCard, afterElement);
            const minimizeBtn = draggedCard.querySelector('.minimize-btn');
            if (targetList.id.startsWith('done-list')) {
                draggedCard.classList.add('done');
                draggedCard.classList.add('minimized');
                minimizeBtn.textContent = 'üîΩ';
            } else {
                draggedCard.classList.remove('done');
                if (targetList.id.startsWith('in-progress-list')) {
                    draggedCard.classList.add('minimized');
                    minimizeBtn.textContent = 'üîΩ';
                } else {
                    draggedCard.classList.remove('minimized');
                    minimizeBtn.textContent = 'üîº';
                }
            }
            saveTasks(activeDate);
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function updateTitleWithPrefixAndColor(card) {
            const titleElement = card.querySelector('h4');
            const baseText = titleElement.dataset.baseText || '';
            const prefix = card.querySelector('.project-tag').textContent;
            const activeContentTagBtn = card.querySelector('.content-tags button:not(.project-tag).active');
            let contentTagText = '';
            let titleBackgroundColor = 'transparent';
            const titleMap = {
                foto: { text: 'FOTO', color: '#FF7F50' },
                clip: { text: 'CLIP', color: '#337AB7' },
                copertura: { text: 'COP', color: '#6A5ACD' }, 
                grafico: { text: 'GRAFICO', color: '#28A745' },
                oggetto: { text: 'OGGETTO', color: '#FFC107' },
                cartina: { text: 'CARTINA', color: '#8B4513' }
            };
            if (activeContentTagBtn) {
                const type = activeContentTagBtn.dataset.type;
                if (titleMap[type]) {
                    contentTagText = `${titleMap[type].text} `;
                    titleBackgroundColor = titleMap[type].color;
                }
            }
            titleElement.textContent = `${prefix}-${contentTagText}${sanitizeHTML(baseText)}`;
            titleElement.style.backgroundColor = titleBackgroundColor;
        }
        function toggleMinimize(card) {
            const isMinimized = card.classList.toggle('minimized');
            card.querySelector('.minimize-btn').textContent = isMinimized ? 'üîΩ' : 'üîº';
            saveTasks(activeDate);
        }
        function editTask(card) {
            const titleElement = card.querySelector('h4');
            if (titleElement.isContentEditable) return;
            const taskButtons = card.querySelector('.task-buttons');
            card.setAttribute('draggable', 'false');
            titleElement.contentEditable = true;
            titleElement.textContent = titleElement.dataset.baseText;
            titleElement.focus();
            taskButtons.style.display = 'none';
            document.getSelection().selectAllChildren(titleElement);
            const finishEditing = () => {
                titleElement.contentEditable = false;
                taskButtons.style.display = 'flex';
                card.setAttribute('draggable', 'true');
                const newBaseText = titleElement.textContent.trim() || 'Nuovo task';
                titleElement.dataset.baseText = newBaseText;
                updateTitleWithPrefixAndColor(card);
                titleElement.removeEventListener('blur', finishEditing);
                titleElement.removeEventListener('keydown', handleKeyDown);
                saveTasks(activeDate);
            };
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') { e.preventDefault(); finishEditing(); } 
                else if (e.key === 'Escape') finishEditing();
            };
            titleElement.addEventListener('blur', finishEditing);
            titleElement.addEventListener('keydown', handleKeyDown);
        }
        function deleteTask(card) {
            if (confirm("Sei sicuro di voler eliminare questo compito?")) { card.remove(); saveTasks(activeDate); }
        }
        function toggleDone(card) {
            const isDone = card.classList.toggle('done');
            const targetList = isDone ? 'done-list' : 'todo-list';
            const minimizeBtn = card.querySelector('.minimize-btn');
            if (isDone) { card.classList.add('minimized'); minimizeBtn.textContent = 'üîΩ'; } 
            else { card.classList.remove('minimized'); minimizeBtn.textContent = 'üîº'; }
            document.getElementById(`${targetList}-${activeDate}`).appendChild(card);
            saveTasks(activeDate);
        }
        function toggleProjectTag(tagElement) {
            const card = tagElement.closest('.task-card');
            tagElement.textContent = tagElement.textContent === 'PO' ? 'QUOT' : 'PO';
            updateTitleWithPrefixAndColor(card);
            saveTasks(activeDate);
        }
        function toggleTag(clickedButton, card) {
            const wasActive = clickedButton.classList.contains('active');
            card.querySelectorAll('.content-tags button:not(.project-tag)').forEach(btn => { btn.classList.remove('active'); });
            if (!wasActive) {
                clickedButton.classList.add('active');
            }
            updateTitleWithPrefixAndColor(card);
            saveTasks(activeDate);
        }
        function serializeCard(card) {
            const graficaBtn = card.querySelector('.request-activation-btn[data-type="grafica"]');
            const ospiteBtn = card.querySelector('.request-activation-btn[data-type="ospite"]');
            const linkInputs = card.querySelectorAll('.links-container .link-input');
            const links = Array.from(linkInputs).map(input => input.value).filter(value => value.trim() !== '');
            const activeContentTagBtn = card.querySelector('.content-tags button:not(.project-tag).active');
            return {
                id: card.id,
                text: card.querySelector('h4').dataset.baseText,
                createdBy: card.dataset.createdBy || 'Sconosciuto',
                lastModifiedBy: auth.currentUser.displayName || 'Utente',
                descrizione: card.querySelector('.descrizione-input').value,
                projectTag: card.querySelector('.project-tag').textContent,
                materiale: card.querySelector('.materiale-input').value,
                links: links,
                location: card.querySelector('.location-btn.active')?.dataset.location || '',
                locationText: card.querySelector('.location-text').value,
                grafica_active: graficaBtn.classList.contains('active'),
                grafica_status: graficaBtn.nextElementSibling.querySelector('.status-toggle-btn').dataset.status,
                grafica_contatto: card.querySelector('.grafica-contact-input').value,
                ospite_active: ospiteBtn.classList.contains('active'),
                ospite_status: ospiteBtn.nextElementSibling.querySelector('.status-toggle-btn').dataset.status,
                ospite_contatto: card.querySelector('.ospite-contact-input').value,
                activeContentTag: activeContentTagBtn ? activeContentTagBtn.dataset.type : '',
                isDone: card.classList.contains('done'),
                minimized: card.classList.contains('minimized')
            };
        }
    </script>
</body>
</html>
